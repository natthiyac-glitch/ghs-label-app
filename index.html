<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHS Label Generator</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GHS Maker">
    
    <!-- 1. Load Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries for Image Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts: Fredoka (Rounded) & Sarabun (Thai) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Sarabun:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #fff7ed; /* Orange-50 */
            background-image: radial-gradient(#fed7aa 1px, transparent 1px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3, .kawaii-font { font-family: 'Fredoka', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #fb923c; }

        /* Cute Inputs */
        input, select, textarea {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #7dd3fc;
            box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.3);
            outline: none;
        }

        /* Print Styles */
        @media print {
            @page { size: landscape; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            #tank-label-preview { 
                position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; 
                border: none; margin: 0; max-width: none; 
                box-shadow: none !important;
                transform: none !important;
                z-index: 9999;
            }
        }
        
        /* Custom Slider Style */
        input[type=range] {
            height: 25px;
            -webkit-appearance: none;
            margin: 5px 0;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            animate: 0.2s;
            background: #e5e7eb;
            border-radius: 10px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #38bdf8;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
        }

        /* Draggable Panel */
        .draggable-panel { cursor: move; user-select: none; }

        /* Modal Overlay to force Center */
        .modal-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
    </style>
</head>
<body class="text-gray-700">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Printer: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>,
            Settings: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Upload: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Type: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>,
            Download: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Close: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Trash: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            ImageIcon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Maximize: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>,
            Move: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>,
            Folder: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>,
            SaveDisk: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            NewWindow: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
        };

        // --- COMPONENTS ---
        const NFPADiamond = ({ health, flammability, instability, special }) => (
            <div className="relative w-full h-full transform hover:scale-105 transition-transform duration-300">
                <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
                    <polygon points="50,50 25,75 0,50 25,25" fill="#60A5FA" stroke="black" strokeWidth="1" />
                    <polygon points="50,50 25,25 50,0 75,25" fill="#F87171" stroke="black" strokeWidth="1" />
                    <polygon points="50,50 75,25 100,50 75,75" fill="#FBBF24" stroke="black" strokeWidth="1" />
                    <polygon points="50,50 75,75 50,100 25,75" fill="white" stroke="black" strokeWidth="1" />
                    <text x="25" y="55" textAnchor="middle" fontSize="22" fontWeight="bold" fill="black" className="font-sans">{health}</text>
                    <text x="50" y="30" textAnchor="middle" fontSize="22" fontWeight="bold" fill="black" className="font-sans">{flammability}</text>
                    <text x="75" y="55" textAnchor="middle" fontSize="22" fontWeight="bold" fill="black" className="font-sans">{instability}</text>
                    <text x="50" y="80" textAnchor="middle" fontSize="16" fontWeight="bold" fill="black" className="font-sans">{special}</text>
                </svg>
            </div>
        );

        const FontSlider = ({ label, value, onChange }) => (
            <div className="flex flex-col mb-2 p-2 bg-white rounded-lg border border-orange-100 shadow-sm">
                <div className="flex justify-between items-center mb-1">
                    <label className="text-xs font-bold text-orange-500 kawaii-font tracking-wide">{label}</label>
                    <span className="text-[10px] text-sky-500 font-bold bg-sky-50 px-2 py-0.5 rounded-full">{Math.round(value * 100)}%</span>
                </div>
                <input 
                    type="range" 
                    min="0.5" 
                    max="2.0" 
                    step="0.05" 
                    value={value} 
                    onChange={(e) => onChange(parseFloat(e.target.value))} 
                />
            </div>
        );

        // --- SHARED LABEL RENDERER ---
        const GHSLabel = ({ formData, scales, id, onClick, isModal }) => (
            <div id={id} onClick={onClick} className={`bg-white border-4 border-black w-full aspect-[1.5/1] flex flex-col shadow-2xl relative overflow-hidden leading-tight mx-auto transition-all duration-300 ${onClick ? 'cursor-pointer' : ''} ${isModal ? '' : 'hover:shadow-orange-200/50 hover:scale-[1.01]'}`}>
                {/* Header */}
                <div className="flex border-b-4 border-black h-[18%] box-border">
                    <div className="w-[25%] bg-yellow-300 flex items-center justify-center border-r-4 border-black p-1">
                        <span className="font-black font-mono tracking-tighter leading-none" style={{ fontSize: `${2.5 * scales.tankId}rem` }}>{formData.tankId}</span>
                    </div>
                    <div className="w-[55%] flex items-center justify-center p-2 text-center border-r-4 border-black">
                        <span className="font-black uppercase leading-none" style={{ fontSize: `${2.2 * scales.productName}rem` }}>{formData.productName || "CHEMICAL NAME"}</span>
                    </div>
                    <div className="w-[20%] flex flex-col items-center justify-center p-1 bg-gray-100">
                        <span className="font-bold text-gray-500 text-[10px] uppercase leading-none mb-1" style={{ fontSize: `${0.7 * scales.unNumber}rem` }}>UN Number / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UN</span>
                        <span className="font-black font-mono leading-none" style={{ fontSize: `${2 * scales.unNumber}rem` }}>{formData.unNumber || "----"}</span>
                    </div>
                </div>

                {/* Body */}
                <div className="flex flex-grow border-b-4 border-black box-border h-[62%]">
                    <div className="w-[30%] border-r-4 border-black flex flex-col">
                        
                        {/* Upper: Pictogram & Signal Word (Merged) */}
                         <div className="flex-grow flex flex-col items-center justify-center p-1 overflow-hidden relative bg-white border-b-4 border-black">
                            {/* Pictogram Area */}
                            <div className="flex-grow flex items-center justify-center w-full">
                                {formData.pictogramImage ? 
                                    <img src={formData.pictogramImage} className="max-h-full max-w-full object-contain" style={{ maxHeight: '100px' }} /> : 
                                    <div className="text-gray-300 text-[10px] text-center w-full h-20 flex items-center justify-center border border-dashed border-gray-200 m-1">Pictogram</div>
                                }
                            </div>
                            
                            {/* Signal Word Area (Directly below) */}
                            <div className="h-auto pb-2 pt-1 flex items-center justify-center relative bg-white w-full">
                                 {formData.signalWord && (
                                    <div className="font-black uppercase tracking-widest px-2 py-0.5 rounded flex items-center justify-center w-full text-center text-black" style={{ fontSize: `1.5rem` }}>
                                        <span className="leading-none">{formData.signalWord}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                         {/* Lower: NFPA (Moved Here) */}
                        <div className="h-[40%] flex flex-col items-center justify-center p-2 relative bg-white">
                             {/* Wrapper to control max size and padding */}
                            <div className="w-full h-full flex items-center justify-center p-1">
                                <div className="aspect-square h-full max-h-[80px]">
                                    <NFPADiamond 
                                        health={formData.nfpaHealth} 
                                        flammability={formData.nfpaFlammability} 
                                        instability={formData.nfpaInstability} 
                                        special={formData.nfpaSpecial} 
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="w-[70%] p-4 flex flex-col justify-start overflow-hidden relative">
                        {/* Hazard Statements */}
                        <div className="mb-4">
                            <h3 className="font-bold underline mb-1 leading-none" style={{ fontSize: `${1.2 * scales.hazard}rem` }}>HAZARD STATEMENTS (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ H phase):</h3>
                            <p className="whitespace-pre-line font-semibold leading-relaxed" style={{ fontSize: `${1 * scales.hazard}rem` }}>{formData.hazardStatements || "..."}</p>
                        </div>

                        {/* Precautionary Statements */}
                        <div>
                            <h3 className="font-bold underline mb-1 leading-none" style={{ fontSize: `${1.2 * scales.precaution}rem` }}>PRECAUTIONARY STATEMENTS (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á):</h3>
                            <p className="whitespace-pre-line font-semibold leading-relaxed" style={{ fontSize: `${1 * scales.precaution}rem` }}>{formData.precautionaryStatements || "..."}</p>
                        </div>
                    </div>
                </div>

                {/* Footer */}
                <div className="h-[20%] flex box-border">
                     {/* PPE Specific (Full width) */}
                    <div className="w-full p-3 flex flex-col bg-blue-50 relative border-r-0">
                         <div className="flex justify-between items-start mb-1">
                             <h3 className="font-bold uppercase text-blue-900 leading-none text-[10px] underline" style={{ fontSize: `${0.8 * scales.ppeHeader}rem` }}>
                                PPE SPECIFIC / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
                             </h3>
                         </div>
                         
                         <div className="flex flex-row h-full gap-2">
                             {/* PPE Text */}
                             <div className="flex-grow w-1/2 overflow-hidden pr-1">
                                 <p className="whitespace-pre-line font-semibold text-blue-900 leading-tight" style={{ fontSize: `${0.9 * scales.ppeText}rem` }}>
                                    {formData.ppeText || "‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô..."}
                                 </p>
                             </div>
                             
                             {/* PPE Images (3 Slots) - Adjusted: Lifted up slightly (pb-2), Removed placeholders */}
                             <div className="w-1/2 flex items-center justify-end gap-1 pb-2">
                                 {formData.ppeImages.map((img, i) => (
                                     <div key={i} className={`h-full w-1/3 flex items-center justify-center p-0.5 ${img ? 'border border-dashed border-blue-300 bg-white' : ''}`}>
                                        {img && <img src={img} className="max-h-full max-w-full object-contain" />}
                                     </div>
                                 ))}
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        );

        // --- MAIN APP ---
        function App() {
            const [formData, setFormData] = useState({
                tankId: 'T-0101',
                productName: '',
                unNumber: '',
                signalWord: 'DANGER ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢',
                hazardStatements: '',
                precautionaryStatements: '', 
                ppeText: '', 
                pictogramImage: null,
                ppeImages: [null, null, null], // Array for 3 PPE images
                nfpaHealth: 0, nfpaFlammability: 0, nfpaInstability: 0, nfpaSpecial: '',
            });

            const [scales, setScales] = useState({
                tankId: 1, productName: 1, unNumber: 1, hazard: 1, precaution: 1, ppeText: 1, ppeHeader: 1
            });
            
            const [savedLabels, setSavedLabels] = useState([]);
            const [showFontPanel, setShowFontPanel] = useState(false);
            const [showLibrary, setShowLibrary] = useState(false);
            const [panelPosition, setPanelPosition] = useState({ x: 20, y: 100 }); 
            const isDragging = useRef(false);
            const dragOffset = useRef({ x: 0, y: 0 });

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.has('tankId')) setFormData(prev => ({ ...prev, tankId: params.get('tankId') }));
                if (params.has('product')) setFormData(prev => ({ ...prev, productName: params.get('product') }));
                if (params.has('un')) setFormData(prev => ({ ...prev, unNumber: params.get('un') }));
                if (params.has('signal')) setFormData(prev => ({ ...prev, signalWord: params.get('signal') }));
                if (params.has('hzd')) setFormData(prev => ({ ...prev, hazardStatements: decodeURIComponent(params.get('hzd')) }));
                if (params.has('prec')) setFormData(prev => ({ ...prev, precautionaryStatements: decodeURIComponent(params.get('prec')) }));
                if (params.has('ppe')) setFormData(prev => ({ ...prev, ppeText: decodeURIComponent(params.get('ppe')) }));

                // Load saved templates
                const saved = localStorage.getItem('ghs_templates');
                if (saved) {
                    try {
                        setSavedLabels(JSON.parse(saved));
                    } catch (e) {
                        console.error("Failed to load templates", e);
                    }
                }
            }, []);

            // Save Template
            const handleSaveTemplate = () => {
                if (!formData.productName) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                    return;
                }
                const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö (Template Name):", formData.productName);
                if (name) {
                    const newTemplate = { id: Date.now(), name, data: { ...formData }, scales: { ...scales } };
                    const updated = [newTemplate, ...savedLabels];
                    setSavedLabels(updated);
                    localStorage.setItem('ghs_templates', JSON.stringify(updated));
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                }
            };
            
            // Load Template
            const handleLoadTemplate = (template) => {
                if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${template.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    setFormData(template.data);
                    if(template.scales) setScales(template.scales);
                    setShowLibrary(false);
                }
            };
            
            // Delete Template
            const handleDeleteTemplate = (id) => {
                if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    const updated = savedLabels.filter(l => l.id !== id);
                    setSavedLabels(updated);
                    localStorage.setItem('ghs_templates', JSON.stringify(updated));
                }
            };

            // Drag Handlers
            const handleDragStart = (e) => {
                isDragging.current = true;
                const rect = e.currentTarget.parentElement.getBoundingClientRect();
                dragOffset.current = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            };

            const handleDragMove = (e) => {
                if (!isDragging.current) return;
                setPanelPosition({
                    x: e.clientX - dragOffset.current.x,
                    y: e.clientY - dragOffset.current.y
                });
            };

            const handleDragEnd = () => {
                isDragging.current = false;
            };

            useEffect(() => {
                window.addEventListener('mousemove', handleDragMove);
                window.addEventListener('mouseup', handleDragEnd);
                return () => {
                    window.removeEventListener('mousemove', handleDragMove);
                    window.removeEventListener('mouseup', handleDragEnd);
                };
            }, []);

            // Handle Main Pictogram Upload
            const handleImageUpload = (e, field) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(prev => ({ ...prev, [field]: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            // Handle PPE Images Upload (Array)
            const handlePPEImageUpload = (e, index) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const newImages = [...formData.ppeImages];
                        newImages[index] = reader.result;
                        setFormData(prev => ({ ...prev, ppeImages: newImages }));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const clearImage = (field) => {
                setFormData(prev => ({ ...prev, [field]: null }));
            };

            const clearPPEImage = (index) => {
                const newImages = [...formData.ppeImages];
                newImages[index] = null;
                setFormData(prev => ({ ...prev, ppeImages: newImages }));
            };

            const updateScale = (key, value) => {
                setScales(prev => ({ ...prev, [key]: value }));
            };

            // --- OPEN IN NEW WINDOW (Robust Capture) ---
            const handleOpenImage = async () => {
                setIsGenerating(true);
                
                // Track initial state
                const wasModalOpen = isModalOpen;

                // Use the visible modal content
                if (!isModalOpen) setIsModalOpen(true);
                
                // Force scroll to top to prevent html2canvas offset bugs
                window.scrollTo(0,0);
                
                // Wait for layout stability
                await new Promise(resolve => setTimeout(resolve, 500)); 
                
                try {
                    const elementToCapture = document.getElementById('tank-label-modal-content');
                    if (!elementToCapture) throw new Error("Element not found");

                    // USE dom-to-image (Better text rendering) if available, fallback to html2canvas
                    const canvas = await html2canvas(elementToCapture, { 
                        scale: 3, 
                        useCORS: true, 
                        logging: false, 
                        backgroundColor: '#ffffff',
                        scrollX: 0,
                        scrollY: -window.scrollY
                    });

                    const imgData = canvas.toDataURL('image/png');

                    // Open New Window with Instructions
                    const newWindow = window.open('', '_blank');
                    if (newWindow) {
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>GHS Label Image - ${formData.tankId || 'Image'}</title>
                                    <style>
                                        body { margin: 0; padding: 20px; background: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; font-family: sans-serif; }
                                        img { max-width: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 10px solid white; margin-bottom: 20px; }
                                        .instructions { color: white; font-size: 1.2em; background: rgba(0,0,0,0.5); padding: 15px 30px; border-radius: 50px; text-align: center; }
                                    </style>
                                </head>
                                <body>
                                    <img src="${imgData}" alt="GHS Label" />
                                    <div class="instructions">
                                        üëâ <strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</strong> ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô..." (Save Image As...)</strong>
                                    </div>
                                </body>
                            </html>
                        `);
                        newWindow.document.close();
                    } else {
                        alert('‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å! ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ô‡∏µ‡πâ');
                    }
                    
                    // Restore state: If modal wasn't open originally, close it.
                    if (!wasModalOpen) {
                        setIsModalOpen(false);
                    }

                } catch (error) {
                    console.error("Error:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û");
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="min-h-screen relative pb-10">
                    
                    {/* Header Bar */}
                    <div className="no-print bg-white/80 backdrop-blur-md shadow-sm border-b border-orange-100 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto p-3 flex flex-col md:flex-row justify-between items-center gap-3">
                            <h1 className="text-2xl font-bold text-orange-500 flex items-center gap-2 kawaii-font">
                                <span className="bg-orange-100 p-2 rounded-full">{Icons.Settings}</span>
                                ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢ GHS
                            </h1>
                            
                            <div className="flex flex-wrap items-center gap-2 justify-center relative">
                                <button onClick={() => setShowLibrary(true)} className="flex items-center gap-2 px-4 py-2 rounded-full border-2 transition-all font-bold text-sm kawaii-font bg-yellow-100 border-yellow-400 text-yellow-700 hover:bg-yellow-200">
                                    {Icons.Folder} ‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≤‡∏¢ (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)
                                </button>
                                
                                <button onClick={handleSaveTemplate} className="flex items-center gap-2 px-4 py-2 rounded-full border-2 transition-all font-bold text-sm kawaii-font bg-white border-green-400 text-green-700 hover:bg-green-50">
                                    {Icons.SaveDisk} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                                
                                <button onClick={() => setShowFontPanel(!showFontPanel)} className={`flex items-center gap-2 px-4 py-2 rounded-full border-2 transition-all font-bold text-sm kawaii-font ${showFontPanel ? 'bg-sky-100 border-sky-400 text-sky-700' : 'bg-white border-gray-200 text-gray-600 hover:border-sky-300 hover:bg-sky-50'}`}>
                                    {Icons.Type} ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏±‡∏Å‡∏©‡∏£
                                </button>

                                {showFontPanel && (
                                    <div className="fixed bg-white p-5 shadow-2xl border-2 border-orange-100 rounded-3xl z-[9999] w-80 grid grid-cols-1 gap-1 animate-fade-in-down" style={{ left: `${panelPosition.x}px`, top: `${panelPosition.y}px` }}>
                                        <div className="flex justify-between items-center border-b border-dashed pb-2 mb-2 draggable-panel" onMouseDown={handleDragStart}>
                                            <h3 className="font-bold text-orange-500 text-sm kawaii-font flex items-center gap-2">{Icons.Move} ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
                                            <button onClick={() => setShowFontPanel(false)} className="text-gray-400 hover:text-red-500 bg-gray-100 hover:bg-red-50 p-1 rounded-full transition">{Icons.Close}</button>
                                        </div>
                                        <div className="max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                            <FontSlider label="‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏±‡∏á (Tank ID)" value={scales.tankId} onChange={v => updateScale('tankId', v)} />
                                            <FontSlider label="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" value={scales.productName} onChange={v => updateScale('productName', v)} />
                                            <FontSlider label="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UN" value={scales.unNumber} onChange={v => updateScale('unNumber', v)} />
                                            <FontSlider label="‡∏Ñ‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (Signal)" value={scales.signal} onChange={v => updateScale('signal', v)} />
                                            <FontSlider label="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢" value={scales.hazard} onChange={v => updateScale('hazard', v)} />
                                            <FontSlider label="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á" value={scales.precaution} onChange={v => updateScale('precaution', v)} />
                                            <FontSlider label="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ PPE" value={scales.ppeHeader} onChange={v => updateScale('ppeHeader', v)} />
                                            <FontSlider label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PPE" value={scales.ppeText} onChange={v => updateScale('ppeText', v)} />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8">
                        
                        {/* LEFT: INPUT */}
                        <div className="no-print w-full lg:w-1/3 bg-white p-6 rounded-3xl shadow-xl shadow-orange-100/50 border border-orange-50 space-y-6 h-fit overflow-y-auto max-h-[85vh]">
                            <div className="space-y-4">
                                <h3 className="font-bold text-orange-500 flex items-center gap-2 text-lg kawaii-font border-b-2 border-orange-100 pb-2"><span className="bg-orange-100 text-orange-600 rounded-lg p-1 text-sm">01</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏±‡∏á</label><input type="text" className="w-full p-2.5 rounded-xl bg-orange-50" value={formData.tankId} onChange={e => setFormData({...formData, tankId: e.target.value})} placeholder="T-0101" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UN</label><input type="text" className="w-full p-2.5 rounded-xl bg-orange-50" value={formData.unNumber} onChange={e => setFormData({...formData, unNumber: e.target.value})} placeholder="1830" /></div>
                                    <div className="col-span-2"><label className="text-xs font-bold text-gray-400 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="text" className="w-full p-2.5 rounded-xl bg-orange-50 font-bold text-gray-700" value={formData.productName} onChange={e => setFormData({...formData, productName: e.target.value})} placeholder="SULFURIC ACID" /></div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                <h3 className="font-bold text-sky-500 flex items-center gap-2 text-lg kawaii-font border-b-2 border-sky-100 pb-2"><span className="bg-sky-100 text-sky-600 rounded-lg p-1 text-sm">02</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</h3>
                                <div>
                                    <label className="text-xs font-bold text-gray-400 ml-1 mb-1 block">‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (Pictogram)</label>
                                    <div className="flex gap-2">
                                        <label className="flex-grow flex flex-col items-center justify-center p-4 border-2 border-dashed border-sky-200 rounded-2xl cursor-pointer hover:bg-sky-50 transition-colors group">
                                            <div className="text-sky-300 group-hover:text-sky-500 transition-colors transform group-hover:scale-110 duration-300">{Icons.Upload}</div>
                                            <span className="mt-1 text-xs font-bold text-sky-400">{formData.pictogramImage ? "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ" : "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ"}</span>
                                            <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, 'pictogramImage')} />
                                        </label>
                                        {formData.pictogramImage && <button onClick={() => clearImage('pictogramImage')} className="flex items-center justify-center w-12 bg-red-50 border-2 border-red-100 rounded-2xl hover:bg-red-100 text-red-400 transition-colors">{Icons.Trash}</button>}
                                    </div>
                                </div>
                                <div className="bg-sky-50 p-3 rounded-xl">
                                    <label className="text-xs font-bold text-gray-400 mb-2 block text-center">‡∏£‡∏´‡∏±‡∏™ NFPA</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {['nfpaHealth', 'nfpaFlammability', 'nfpaInstability', 'nfpaSpecial'].map((f, i) => (
                                            <div key={f} className="text-center">
                                                <span className={`text-[10px] font-bold block mb-1 ${['text-blue-500','text-red-500','text-yellow-500','text-gray-500'][i]}`}>{['H','F','I','S'][i]}</span>
                                                <input className="border-2 p-1 text-center w-full rounded-lg font-bold" value={formData[f]} onChange={e => setFormData({...formData, [f]: e.target.value})} />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="mb-1"><label className="text-xs font-bold text-gray-400 ml-1">‡∏Ñ‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</label><select className="w-full p-2.5 rounded-xl bg-sky-50 font-bold text-gray-600" value={formData.signalWord} onChange={e => setFormData({...formData, signalWord: e.target.value})}><option value="DANGER ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢">üî¥ DANGER ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</option><option value="WARNING ‡∏£‡∏∞‡∏ß‡∏±‡∏á">üü† WARNING ‡∏£‡∏∞‡∏ß‡∏±‡∏á</option><option value="NONE ‡πÑ‡∏°‡πà‡∏°‡∏µ">‚ö™ NONE ‡πÑ‡∏°‡πà‡∏°‡∏µ</option></select></div>
                                <div className="mb-1"><label className="text-xs font-bold text-gray-400 ml-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</label><textarea className="w-full p-3 rounded-xl bg-sky-50 text-sm" rows="4" value={formData.hazardStatements} onChange={e => setFormData({...formData, hazardStatements: e.target.value})}></textarea></div>
                                <div><label className="text-xs font-bold text-gray-400 ml-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á</label><textarea className="w-full p-3 rounded-xl bg-sky-50 text-sm" rows="3" value={formData.precautionaryStatements} onChange={e => setFormData({...formData, precautionaryStatements: e.target.value})}></textarea></div>
                            </div>

                            <div className="space-y-4">
                                <h3 className="font-bold text-amber-500 flex items-center gap-2 text-lg kawaii-font border-b-2 border-amber-100 pb-2"><span className="bg-amber-100 text-amber-600 rounded-lg p-1 text-sm">03</span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h3>
                                <div className="bg-orange-50 p-4 rounded-2xl">
                                    <label className="text-xs font-bold text-orange-400 mb-2 block">PPE Specific / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á</label>
                                    <textarea className="w-full p-3 rounded-xl bg-orange-50 text-sm border-2 border-orange-200" rows="3" value={formData.ppeText} onChange={e => setFormData({...formData, ppeText: e.target.value})} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå PPE ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ..."></textarea>
                                </div>

                                {/* PPE Images Upload (3 Slots) */}
                                <div className="bg-orange-50 p-4 rounded-2xl">
                                    <label className="text-xs font-bold text-orange-400 mb-1 block">‡∏£‡∏π‡∏õ PPE (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {[0, 1, 2].map(index => (
                                            <div key={index} className="relative">
                                                <label className="flex flex-col items-center justify-center p-2 border-2 border-dashed border-orange-200 bg-white rounded-xl cursor-pointer hover:bg-orange-100 transition-colors h-24">
                                                    {formData.ppeImages[index] ? (
                                                        <img src={formData.ppeImages[index]} className="max-h-full max-w-full object-contain" />
                                                    ) : (
                                                        <>
                                                            <div className="text-orange-300 mb-1">{Icons.Upload}</div>
                                                            <span className="text-[10px] font-bold text-orange-400 text-center">‡∏£‡∏π‡∏õ {index + 1}</span>
                                                        </>
                                                    )}
                                                    <input type="file" accept="image/*" className="hidden" onChange={(e) => handlePPEImageUpload(e, index)} />
                                                </label>
                                                {formData.ppeImages[index] && (
                                                    <button 
                                                        onClick={() => clearPPEImage(index)} 
                                                        className="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full p-1 shadow-sm hover:bg-red-200"
                                                        title="‡∏•‡∏ö‡∏£‡∏π‡∏õ"
                                                    >
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: PREVIEW */}
                        <div className="w-full lg:w-2/3 flex flex-col items-center pt-4">
                            <div className="no-print mb-4 flex items-center gap-2 text-gray-400 text-sm font-bold bg-white px-4 py-1 rounded-full shadow-sm animate-bounce">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</div>
                            <div className="preview-container relative w-full flex justify-center group">
                                <GHSLabel id="tank-label-preview" formData={formData} scales={scales} onClick={() => setIsModalOpen(true)} />
                                <div className="overlay absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none rounded-lg"><div className="bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 transform scale-0 group-hover:scale-100 transition-transform duration-300">{Icons.Maximize} ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢</div></div>
                            </div>
                        </div>
                    </div>

                    {/* MODAL & LIBRARY */}
                    {showLibrary && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden relative">
                                <div className="p-4 border-b bg-yellow-50 flex justify-between items-center"><h3 className="font-bold text-yellow-700 text-lg kawaii-font">‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≤‡∏¢ (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</h3><button onClick={() => setShowLibrary(false)} className="text-gray-400 hover:text-red-500">{Icons.Close}</button></div>
                                <div className="p-4 overflow-y-auto flex-grow bg-white">{savedLabels.length === 0 ? (<div className="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>) : (<div className="space-y-2">{savedLabels.map(template => (<div key={template.id} className="flex justify-between items-center p-3 border rounded-xl hover:bg-gray-50 transition"><div><div className="font-bold text-gray-700">{template.name}</div><div className="text-xs text-gray-400">{template.data.tankId} ‚Ä¢ {new Date(template.id).toLocaleDateString()}</div></div><div className="flex gap-2"><button onClick={() => handleLoadTemplate(template)} className="px-3 py-1 bg-green-100 text-green-600 rounded-lg text-xs font-bold hover:bg-green-200">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button><button onClick={() => handleDeleteTemplate(template.id)} className="p-1.5 text-red-400 hover:bg-red-50 rounded-lg">{Icons.Trash}</button></div></div>))}</div>)}</div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-6xl max-h-[95vh] flex flex-col overflow-hidden relative">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-50 z-10 relative"> 
                                    <h2 className="text-xl font-bold text-gray-700 flex items-center gap-2 kawaii-font">{Icons.ImageIcon} ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢</h2>
                                    <div className="flex gap-2">
                                        {/* Updated: Open in New Window Button */}
                                        <button onClick={handleOpenImage} disabled={isGenerating} className="flex items-center gap-2 bg-gradient-to-r from-orange-400 to-red-500 text-white px-6 py-2 rounded-full font-bold hover:shadow-lg hover:scale-105 transition-all text-sm kawaii-font disabled:opacity-50">
                                            {Icons.NewWindow} {isGenerating ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...' : '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà'}
                                        </button>
                                        <button onClick={() => setIsModalOpen(false)} className="bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-full transition">{Icons.Close}</button>
                                    </div>
                                </div>
                                <div className="p-4 md:p-8 overflow-y-auto bg-gray-100 flex-grow flex justify-center items-start modal-overlay">
                                    <div className="shadow-2xl w-full"><GHSLabel id="tank-label-modal-content" formData={formData} scales={scales} isModal={true} /></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>