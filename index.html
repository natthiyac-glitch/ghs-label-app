<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tank Farm GHS Generator</title>
    
    <!-- 1. Load Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Print Styles */
        @media print {
            @page { size: landscape; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            #tank-label { 
                position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; 
                border: none; margin: 0; max-width: none; 
                box-shadow: none !important;
                transform: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf;

        // --- ICONS (SVG Strings) ---
        const Icons = {
            Printer: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2-2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>,
            Settings: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Upload: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Type: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
            Download: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        };

        const EXTINGUISHING_MEDIA = ["Water Spray (น้ำ)", "Foam (โฟม)", "Carbon Dioxide (CO2)", "Dry Chemical (ผงเคมีแห้ง)", "Do NOT use water (ห้ามใช้น้ำ)"];
        
        // --- PPE LIST (Updated) ---
        const PPE_LIST = [
            "Safety Helmet (หมวกนิรภัย)",           
            "Safety Glasses / Goggles (แว่นตานิรภัย)",
            "Chemical Mask (หน้ากากกันสารเคมี)",    
            "Full Face Mask (หน้ากากเต็มหน้า)",
            "Chemical Resistant Gloves (ถุงมือยาง)",
            "Protective Suit (ชุดป้องกันสารเคมี)",
            "Safety Boots (รองเท้านิรภัย)"
        ];

        // --- COMPONENTS ---
        const NFPADiamond = ({ health, flammability, instability, special }) => (
            <div className="relative w-full h-full">
                <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
                    <polygon points="50,50 25,75 0,50 25,25" fill="#3b82f6" stroke="black" strokeWidth="1" />
                    <polygon points="50,50 25,25 50,0 75,25" fill="#ef4444" stroke="black" strokeWidth="1" />
                    <polygon points="50,50 75,25 100,50 75,75" fill="#eab308" stroke="black" strokeWidth="1" />
                    <polygon points="50,50 75,75 50,100 25,75" fill="white" stroke="black" strokeWidth="1" />
                    <text x="25" y="55" textAnchor="middle" fontSize="22" fontWeight="bold" fill="black">{health}</text>
                    <text x="50" y="30" textAnchor="middle" fontSize="22" fontWeight="bold" fill="black">{flammability}</text>
                    <text x="75" y="55" textAnchor="middle" fontSize="22" fontWeight="bold" fill="black">{instability}</text>
                    <text x="50" y="80" textAnchor="middle" fontSize="16" fontWeight="bold" fill="black">{special}</text>
                </svg>
            </div>
        );

        // --- MAIN APP ---
        function App() {
            const [formData, setFormData] = useState({
                tankId: 'T-0101',
                productName: '',
                unNumber: '',
                signalWord: 'DANGER',
                hazardStatements: '',
                selectedExtMedia: [],
                selectedPPEList: [],
                pictogramImage: null,
                ppeImage: null,
                nfpaHealth: 0, nfpaFlammability: 0, nfpaInstability: 0, nfpaSpecial: '',
            });
            const [fontScale, setFontScale] = useState(1);
            const [isGenerating, setIsGenerating] = useState(false);
            const labelRef = useRef(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.has('tankId')) setFormData(prev => ({ ...prev, tankId: params.get('tankId') }));
                if (params.has('product')) setFormData(prev => ({ ...prev, productName: params.get('product') }));
                if (params.has('un')) setFormData(prev => ({ ...prev, unNumber: params.get('un') }));
                if (params.has('signal')) setFormData(prev => ({ ...prev, signalWord: params.get('signal') }));
                if (params.has('hzd')) setFormData(prev => ({ ...prev, hazardStatements: decodeURIComponent(params.get('hzd')) }));
            }, []);

            const handleImageUpload = (e, field) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(prev => ({ ...prev, [field]: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            const toggleSelection = (field, item) => {
                setFormData(prev => {
                    const list = prev[field];
                    return list.includes(item) ? { ...prev, [field]: list.filter(i => i !== item) } : { ...prev, [field]: [...list, item] };
                });
            };

            const handleDownloadPDF = async () => {
                setIsGenerating(true);
                await new Promise(resolve => setTimeout(resolve, 100)); // Wait for render
                
                try {
                    // Clone the element to a hidden container
                    const originalElement = document.getElementById('tank-label');
                    const clone = originalElement.cloneNode(true);
                    
                    // Create a hidden container with FIXED dimensions
                    const container = document.createElement('div');
                    container.style.position = 'absolute';
                    container.style.top = '-9999px';
                    container.style.left = '-9999px';
                    container.style.width = '1200px'; 
                    container.style.height = '800px'; 
                    container.appendChild(clone);
                    document.body.appendChild(container);
                    
                    // Capture with scaling
                    const canvas = await html2canvas(clone, { 
                        scale: 2, 
                        useCORS: true,
                        logging: false,
                        windowWidth: 1200,
                        windowHeight: 800
                    });
                    
                    // Cleanup
                    document.body.removeChild(container);

                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`GHS-Label-${formData.tankId || 'Export'}.pdf`);
                } catch (error) {
                    console.error("PDF Error:", error);
                    alert("เกิดข้อผิดพลาดในการสร้าง PDF");
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="min-h-screen">
                    {/* Control Panel */}
                    <div className="no-print p-4 bg-white shadow-md border-b sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <h1 className="text-xl font-bold text-gray-700 flex items-center gap-2">
                                {Icons.Settings} สร้างป้าย Tank Farm
                            </h1>
                            <div className="flex flex-wrap items-center gap-2 justify-center">
                                <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border">
                                    {Icons.Type}
                                    <div className="flex flex-col">
                                        <label className="text-[10px] font-bold text-gray-500">ขนาดตัวหนังสือ</label>
                                        <input type="range" min="0.5" max="1.5" step="0.1" value={fontScale} onChange={(e) => setFontScale(parseFloat(e.target.value))} className="w-24 cursor-pointer" />
                                    </div>
                                </div>
                                <button onClick={handleDownloadPDF} disabled={isGenerating} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition shadow-sm disabled:opacity-50">
                                    {Icons.Download} {isGenerating ? 'กำลังสร้าง...' : 'บันทึก PDF'}
                                </button>
                                <button onClick={() => window.print()} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-sm">
                                    {Icons.Printer} พิมพ์ป้าย
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4 flex flex-col lg:flex-row gap-6">
                        {/* INPUT FORM */}
                        <div className="no-print w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-sm border space-y-6 h-fit overflow-y-auto max-h-[90vh]">
                            <div className="space-y-3">
                                <h3 className="font-bold border-b pb-1 text-blue-800">1. ข้อมูลทั่วไป</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="text" className="border p-2 rounded" value={formData.tankId} onChange={e => setFormData({...formData, tankId: e.target.value})} placeholder="Tank ID" />
                                    <input type="text" className="border p-2 rounded" value={formData.unNumber} onChange={e => setFormData({...formData, unNumber: e.target.value})} placeholder="UN Number" />
                                    <input type="text" className="col-span-2 border p-2 rounded font-bold" value={formData.productName} onChange={e => setFormData({...formData, productName: e.target.value})} placeholder="Product Name" />
                                </div>
                            </div>

                             <div className="space-y-3">
                                <h3 className="font-bold border-b pb-1 text-blue-800">2. ข้อมูลอันตราย</h3>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">Pictogram (รูปภาพ)</label>
                                    <label className="flex w-full items-center justify-center p-2 border-2 border-dashed rounded cursor-pointer hover:bg-gray-50">
                                        {Icons.Upload} <span className="ml-2 text-sm">{formData.pictogramImage ? "เปลี่ยนรูป" : "อัปโหลด"}</span>
                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, 'pictogramImage')} />
                                    </label>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1">NFPA (ตัวเลข)</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        <div className="text-center">
                                            <span className="text-xs text-blue-600 font-bold">H</span>
                                            <input className="border p-1 text-center w-full rounded" value={formData.nfpaHealth} onChange={e => setFormData({...formData, nfpaHealth: e.target.value})} />
                                        </div>
                                        <div className="text-center">
                                            <span className="text-xs text-red-600 font-bold">F</span>
                                            <input className="border p-1 text-center w-full rounded" value={formData.nfpaFlammability} onChange={e => setFormData({...formData, nfpaFlammability: e.target.value})} />
                                        </div>
                                        <div className="text-center">
                                            <span className="text-xs text-yellow-500 font-bold">I</span>
                                            <input className="border p-1 text-center w-full rounded" value={formData.nfpaInstability} onChange={e => setFormData({...formData, nfpaInstability: e.target.value})} />
                                        </div>
                                        <div className="text-center">
                                            <span className="text-xs text-gray-500 font-bold">S</span>
                                            <input className="border p-1 text-center w-full rounded" value={formData.nfpaSpecial} onChange={e => setFormData({...formData, nfpaSpecial: e.target.value})} />
                                        </div>
                                    </div>
                                </div>

                                <select className="w-full border p-2 rounded" value={formData.signalWord} onChange={e => setFormData({...formData, signalWord: e.target.value})}>
                                    <option value="DANGER">DANGER</option> <option value="WARNING">WARNING</option> <option value="">NONE</option>
                                </select>
                                <textarea className="w-full border p-2 rounded text-sm" rows="5" value={formData.hazardStatements} onChange={e => setFormData({...formData, hazardStatements: e.target.value})} placeholder="Hazard Statements"></textarea>
                            </div>

                            <div className="space-y-3">
                                <h3 className="font-bold border-b pb-1 text-blue-800">3. ความปลอดภัย</h3>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">สารดับเพลิง</label>
                                    {EXTINGUISHING_MEDIA.map(item => (
                                        <label key={item} className="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="checkbox" checked={formData.selectedExtMedia.includes(item)} onChange={() => toggleSelection('selectedExtMedia', item)} /> {item}
                                        </label>
                                    ))}
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">PPE</label>
                                    {PPE_LIST.map(item => (
                                        <label key={item} className="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="checkbox" checked={formData.selectedPPEList.includes(item)} onChange={() => toggleSelection('selectedPPEList', item)} /> {item}
                                        </label>
                                    ))}
                                    <label className="flex w-full items-center justify-center p-2 border-2 border-dashed rounded cursor-pointer hover:bg-gray-50 mt-2">
                                        {Icons.Upload} <span className="ml-2 text-sm">{formData.ppeImage ? "เปลี่ยนรูป PPE" : "อัปโหลดรูป PPE"}</span>
                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, 'ppeImage')} />
                                    </label>
                                </div>
                            </div>
                        </div>

                        {/* PREVIEW AREA */}
                        <div className="w-full lg:w-2/3 flex justify-center items-start pt-4">
                            <div id="tank-label" ref={labelRef} className="bg-white border-4 border-black w-full max-w-[900px] aspect-[1.5/1] flex flex-col shadow-2xl relative overflow-hidden leading-tight">
                                {/* Header */}
                                <div className="flex border-b-4 border-black h-[18%] box-border">
                                    <div className="w-[20%] bg-yellow-300 flex items-center justify-center border-r-4 border-black p-1">
                                        {/* FIX: Removed fix-vertical-align class, removed negative margin, added leading-none */}
                                        <span className="font-black font-mono tracking-tighter leading-none" style={{ fontSize: `${2.5 * fontScale}rem` }}>{formData.tankId}</span>
                                    </div>
                                    <div className="w-[60%] flex items-center justify-center p-2 text-center border-r-4 border-black">
                                        <span className="font-black uppercase leading-none" style={{ fontSize: `${2.2 * fontScale}rem` }}>{formData.productName || "CHEMICAL NAME"}</span>
                                    </div>
                                    <div className="w-[20%] flex flex-col items-center justify-center p-1 bg-gray-100">
                                        <span className="font-bold text-gray-500 uppercase leading-none mb-1" style={{ fontSize: `${0.7 * fontScale}rem` }}>UN Number</span>
                                        <span className="font-black font-mono leading-none" style={{ fontSize: `${2 * fontScale}rem` }}>{formData.unNumber || "----"}</span>
                                    </div>
                                </div>

                                {/* Body */}
                                <div className="flex flex-grow border-b-4 border-black box-border h-[62%]">
                                    <div className="w-[30%] border-r-4 border-black flex flex-col">
                                        <div className="h-[60%] flex flex-col items-center justify-center p-2 gap-2">
                                            <div className="w-24 h-24 lg:w-32 lg:h-32">
                                                <NFPADiamond 
                                                    health={formData.nfpaHealth} 
                                                    flammability={formData.nfpaFlammability} 
                                                    instability={formData.nfpaInstability} 
                                                    special={formData.nfpaSpecial} 
                                                />
                                            </div>
                                            {formData.signalWord && (
                                                /* FIX: Removed negative margins, added leading-none and explicit padding */
                                                <div className={`font-black uppercase tracking-widest px-4 py-2 rounded flex items-center justify-center ${formData.signalWord === 'DANGER' ? 'bg-red-600 text-white' : 'bg-orange-500 text-white'}`} style={{ fontSize: `${1.5 * fontScale}rem` }}>
                                                    <span className="leading-none">{formData.signalWord}</span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="h-[40%] border-t-4 border-black bg-white flex items-center justify-center p-1 overflow-hidden relative">
                                            {formData.pictogramImage ? <img src={formData.pictogramImage} className="max-h-full max-w-full object-contain" /> : <div className="text-gray-300 text-xs text-center border-2 border-dashed w-full h-full flex items-center justify-center">Pictogram Area</div>}
                                        </div>
                                    </div>
                                    <div className="w-[70%] p-4 flex flex-col justify-start overflow-hidden">
                                        <h3 className="font-bold underline mb-2 leading-none" style={{ fontSize: `${1.2 * fontScale}rem` }}>HAZARD STATEMENTS:</h3>
                                        <p className="whitespace-pre-line font-semibold leading-relaxed" style={{ fontSize: `${1 * fontScale}rem` }}>{formData.hazardStatements || "..."}</p>
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="h-[20%] flex box-border">
                                    <div className="w-[40%] border-r-4 border-black p-2 flex flex-col bg-white">
                                        <div className="flex items-center justify-center mb-1">
                                            {/* FIX: Leading none, removed negative margin, used py-1 */}
                                            <span className="font-bold uppercase bg-black text-white px-3 py-1 rounded flex items-center justify-center leading-none" style={{ fontSize: `${0.8 * fontScale}rem` }}>
                                                Extinguishing Media
                                            </span>
                                        </div>
                                        <div className="flex-grow overflow-hidden pl-2 pt-1">
                                            <ul className="list-disc list-inside font-bold leading-tight space-y-0.5" style={{ fontSize: `${0.9 * fontScale}rem` }}>
                                                {formData.selectedExtMedia.map(item => <li key={item}>{item}</li>)}
                                            </ul>
                                        </div>
                                    </div>
                                    <div className="w-[60%] p-2 flex bg-blue-50">
                                        <div className="w-1/2 pr-2 flex flex-col border-r border-blue-200">
                                            <div className="flex items-center justify-start mb-1">
                                                {/* FIX: Leading none, removed negative margin, used py-1 */}
                                                <span className="font-bold uppercase bg-blue-800 text-white px-3 py-1 rounded flex items-center justify-center leading-none" style={{ fontSize: `${0.8 * fontScale}rem` }}>
                                                    PPE Required
                                                </span>
                                            </div>
                                            <div className="flex-grow overflow-hidden pl-1">
                                                <ul className="space-y-0.5" style={{ fontSize: `${0.75 * fontScale}rem` }}>
                                                    {formData.selectedPPEList.map(item => <li key={item} className="flex items-start gap-1"><span className="font-semibold text-blue-900 leading-tight">• {item}</span></li>)}
                                                </ul>
                                            </div>
                                        </div>
                                        <div className="w-1/2 pl-2 flex items-center justify-center relative">
                                            {formData.ppeImage ? <img src={formData.ppeImage} className="max-h-full max-w-full object-contain" /> : <div className="text-blue-300 text-xs text-center border-2 border-dashed border-blue-200 w-full h-full flex items-center justify-center">PPE Image</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>